<html>
  <head>
    <title>Swaggy CoinClickers Button</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- Import local script files -->
    <script>
      const exports = {}; //Fixes i18n Stuff lol.
    </script>
    <script src="/scripts/jquery.min.js"></script>
    <script src="/scripts/snackbar.js"></script>
    <script src="/scripts/i18n.source.js">
      //j18n-Source
    </script>
    <script src="/scripts/i18n.js">
      //j18n Translations
    </script>
    <link rel="stylesheet" href="style/snackbar.css" />
    <style>
      html {
        height: 100%;
      }

      body {
        min-height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        justify-content: space-evenly;
        align-items: center;
        align-content: center;
        justify-content: center;
        align-items: center;
        background-color: #24282f;
      }

      .flexbox-item {
       flex: 0 1 auto;
      }

      .flex-item:nth-child(1) {
          flex-grow: 0;
          flex-shrink: 1;
          flex-basis: auto;
      }

      .flex-item:nth-child(2) {
          flex-grow: 0;
          flex-shrink: 1;
          flex-basis: auto;
      }

      .flex-item:nth-child(3) {
          flex-grow: 0;
          flex-shrink: 1;
          flex-basis: auto;
      }

      /* Button */
      button {
        position: relative;
        z-index: 3;
        border-radius: 50%;
        width: 300px;
        height: 300px;
        border: none;
        color: white;
        font-family: Avenir, Arial, sans-serif;
        font-weight: 900;
        font-size: 3.5rem;
        background: rgba(255, 0, 0, 1);
        text-shadow: 0 5px 1px rgba(122, 17, 8, 0.8);
        box-shadow: 0 8px 0 rgb(183, 9, 0), 0 15px 20px rgba(0, 0, 0, 0.35);
        text-transform: uppercase;
        transition: 0.4s all ease-in;
        outline: none;
        cursor: pointer;
        text-align: center;
      }

      button span {
        position: relative;
      }

      /* fix for IE 11 (and IE8+, although the earlier versions are harder to address) stupidly moving the inner button text on click */
      .pressed {
        padding-top: 3px;
        transform: translateY(4px);
        box-shadow: 0 4px 0 rgb(183, 0, 0), 0 8px 6px rgba(0, 0, 0, 0.45);
      }

      /* Input Field */
      input[type="text"] {
        width: 80%;
        z-index: 4;
        text-align: center;
        position: relative;
        background: rgb(253, 96, 96);
        border: 2px solid rgb(155, 0, 0);
        border-radius: 4px;
        margin: 8px 0;
        outline: none;
        padding: 8px;
        box-sizing: border-box;
        transition: 0.3s;
      }

      input[type="text"]:focus {
        border-color: dodgerBlue;
        box-shadow: 0 0 8px 0 dodgerBlue;
      }
    </style>
  </head>

  <body>
    <div class="body.flex-item">
      Stuff
    </div>
    <div class="body.flex-item">
      <button id="CoinButton" type="button">
        Coins!<input type="text" id="UserToGiveCoins" placeholder="E-Mail" />
      </button>
      <!-- <input type="text" id="UserToBan" placeholder="Username"> -->
    </div>
  </body>
</html>

<script>
  const $input = $("#UserToGiveCoins");
  let typingTimer; //timer identifier
  let doneTypingInterval = 650; //time in ms
  let isLocked = true;

  let click_timeout = 0;

  const SnackBox_Timeout = 400;
  const SnackBox_Location = "tr";

  const getUrl = window.location;
  const baseUrl = getUrl.protocol + "//" + getUrl.host + "/";

  let webSocket;

  /* Focus on input field */
  $input.focus();
  $input.select();

  /* Dedect typing the email */
  $input.on("keyup", function () {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(doneTyping, doneTypingInterval);
  });

  $input.on("keydown", function () {
    clearTimeout(typingTimer);
  });

  function doneTyping() {
    const email = document.getElementById("UserToGiveCoins").value;
    posting = $.ajax({
      url: `${baseUrl}api/application/user`,
      type: "GET",
      contentType: "application/json; charset=utf-8",
      data: { email: email },
      success: function (EmailResponse) {
        if (EmailResponse.user) {
          $("#UserToGiveCoins").attr("disabled", "disabled");
          localStorage.setItem("email", email);

          webSocket = new WebSocket(`ws://${getUrl.host}/api/application/websocket?email=${email}`);

            webSocket.onerror = function(event) {
                SnackBar({
                    message: `${translate("WS.LostConError")}`,
                    width: "300px",
                    speed: SnackBox_Timeout,
                    position: SnackBox_Location,
                    fixed: true,
                    status: "error",
                });
            };
            
            webSocket.onmessage = function(event) {
              const data = JSON.parse(event.data);
              
              if(data.code === 200){
                if(data.data.email === localStorage.getItem("email")){
                  isLocked = false;
                  click_timeout = data.data.config.click_timeout;
                }
              } else if(data.code === 400){
                if(data.message === "Reached_Day_limit"){
                  SnackBar({
                    message: `${translate("WS.Reached_Day_limit")}`,
                    width: "300px",
                    speed: SnackBox_Timeout,
                    position: SnackBox_Location,
                    fixed: true,
                    status: "error",
                });
                }
              } else {
                SnackBar({
                    message: `${translate("WS.UnknownError")}`,
                    width: "300px",
                    speed: SnackBox_Timeout,
                    position: SnackBox_Location,
                    fixed: true,
                    status: "error",
                });
              }
            };

          SnackBar({
            message: `${translate("Startup.UserFound")}`,
            width: "300px",
            speed: SnackBox_Timeout,
            position: SnackBox_Location,
            fixed: true,
            status: "success",
          });
        }
      },
      error: function (err) {
        console.log(err);
        if(err.status == 404){localStorage.removeItem("email");}
        if (err.status != 400) {
          SnackBar({
            message: `Error ${err.status} - ${translate(
              "Error." + err.status
            )}`,
            width: "300px",
            speed: SnackBox_Timeout,
            position: SnackBox_Location,
            fixed: true,
            status: "error",
          });
        }
      },
    });
  }

  //Button handler
  const MainButton = document.getElementById("CoinButton");

  function press() {
    MainButton.classList.add("pressed");
  }

  function unpress() {
    MainButton.classList.remove("pressed");
  }

  MainButton.addEventListener("click", function () {
    if (!isLocked) {
      press();
      webSocket.send(JSON.stringify({code: 200, message: 'Button was pressed', data: {request: "button_pressed"}}));
      isLocked = true;
      //Unlock Button after timeout
      setTimeout(function () {
        isLocked = false;
      }, click_timeout);
      //Reset Button as anomation
      setTimeout(function () {
        unpress();
      }, 500);
    }
  });

  $(document).ready(function () {
    if (localStorage.getItem("email") != null) {
      $input.val(localStorage.getItem("email"));
      doneTyping();
    } else {
      SnackBar({
        message: `${translate("Startup.Welcome")}`,
        width: "600px",
        speed: SnackBox_Timeout,
        position: SnackBox_Location,
        fixed: true,
        status: "info",
      });
    }
  });
</script>
